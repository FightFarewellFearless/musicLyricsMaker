name: Upload to youtube
run-name: YTUP ${{ github.event.inputs.identifier }}
on:
  workflow_dispatch:
    inputs:
      type:
        description: 'Type of video'
        type: choice
        options:
          - portrait
          - landscape
        default: "landscape"
        required: true
      scale:
        description: 'Scale'
        type: string
        default: "1"
        required: true
      identifier:
        description: 'Identifier'
        type: string
        required: true
      props:
        description: Video Props
        required: true
        default: |
          {
            "musicTitle": "",
            "translateTo": "none",
            "syncronizeLyrics": [],
            "translateSyncronizeLyrics": [],
            "background": "default",
            "ytmMusicInfo": "",
            "ytmThumbnail": "",
            "searchLyricsIndex": 0
          }
jobs:
  mempersiapkan-data-yang-diperlukan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # --- 1. APT CACHE (Local Folder Method) ---
      # Caches .deb files to a local folder to avoid /var/cache permission errors
      - name: Cache Apt Packages
        uses: actions/cache@v4
        with:
          path: apt-cache
          key: ${{ runner.os }}-apt-ffmpeg
      
      - name: Install Apt Deps
        run: |
          mkdir -p apt-cache
          sudo apt-get update
          # -o dir::cache::archives points apt to our local folder
          sudo apt-get install -y ffmpeg -o dir::cache::archives="$PWD/apt-cache"
          # Ensure we own the cache so GitHub can save it
          sudo chown -R $USER apt-cache

      # --- 2. PYTHON SETUP ---
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # --- 3. VENV CACHE (Cache Installed Software) ---
      - name: Cache Virtual Env
        id: cache-venv
        uses: actions/cache@v4
        with:
          path: venv
          # Change 'v1' to 'v2' if you change your pip install command later
          key: ${{ runner.os }}-venv-v1-audio-separator

      - name: Install Dependencies
        # This step is SKIPPED if the cache is found!
        if: steps.cache-venv.outputs.cache-hit != 'true'
        run: |
          echo "Cache miss! Installing dependencies..."
          python -m venv venv
          source venv/bin/activate
          pip install "audio-separator[cpu]"

      - name: Set up WARP
        uses: fscarmen/warp-on-actions@v1.4
        with:
          stack: dual        # Optional. Support [ ipv4, ipv6, dual ]. Default is dual.
          mode: client    # Optional. Support [ wireguard, client ]. Default is wireguard.
      - uses: actions/checkout@main
      - uses: FedericoCarboni/setup-ffmpeg@v2
      - name: install dependencies
        run: npm i

      - name: run node
        shell: bash
        env:
          YT_COOKIE: ${{ secrets.ytcookie }}
          PROPS: ${{ github.event.inputs.props }}
        run: echo $PROPS > props.json && node downloadAudio
      - uses: actions/upload-artifact@main
        with:
          name: audioDownload
          path: |
            ./public
  call-workflow-in-another-repo:
    needs: [mempersiapkan-data-yang-diperlukan]
    uses: FightFarewellFearless/Remotion-Matrix-Renderer/.github/workflows/render-video-matrix.yml@master
    with:
      num_of_workers: 10
      remotion_composition_id: ${{ github.event.inputs.type == 'portrait' && 'MusicLyricsPortrait' || 'MusicLyrics' }}
      remotion_entry_point: src/index.ts
      props: ${{ github.event.inputs.props }}
      scale: ${{ github.event.inputs.scale }}
      id: ${{ github.event.inputs.identifier }}

  uploading-to-youtube:
    needs: [call-workflow-in-another-repo]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@main
      - uses: actions/download-artifact@v4
        with:
          name: video
          path: video
      - name: Installing deps
        run: npm i
      - uses: actions/download-artifact@v4
        with:
          name: audioDownload
          path: public
      - name: Uploading...
        env:
          OAUTH2ENV: ${{ secrets.OAUTH2ENV }}
          VIDEO_PATH: video
          PROPS: ${{ github.event.inputs.props }}
        run: echo "$OAUTH2ENV" | base64 --decode > .env && echo $PROPS > props.json && node upload.js
